# HNG12 Stage 4 TODO Application Infrastructure Overview

This repository (**hng12-stage4-todo-infra**) contains the infrastructure as code (IaC) setup for deploying a TODO application on AWS using **Terraform** and **Ansible**. The application is hosted at [https://oluwatobiloba.tech](https://oluwatobiloba.tech), and a wildcard A record (`*.oluwatobiloba.tech`) allows subdomains to point to the same EC2 instance.

## Description of Infrastructure and Deployment Process

### Infrastructure Components

- **AWS EC2 Instance**:
  - Single **t2.medium** instance running **Ubuntu 22.04 LTS**.
  - Hosts the TODO application using **Docker** containers.

- **AWS Security Group**:
  - Allows inbound traffic on:
    - **Port 22 (SSH)** for provisioning.
    - **Port 80 (HTTP)** for application access.
    - **Port 443 (HTTPS)** for secure application access.
  - Allows all outbound traffic.

- **AWS Route53**:
  - An **A record** for `oluwatobiloba.tech` pointing to the EC2 instance’s public IP.
  - A **wildcard A record** (`*.oluwatobiloba.tech`) pointing to the same EC2 instance’s public IP for subdomains.

- **Ansible Inventory**:
  - Dynamically generated by Terraform at `ansible/inventory.ini`.
  - Uses a variable `${public_ip}` sourced from Terraform outputs.

### Deployment Process

#### **Terraform**
1. Provisions AWS resources (**EC2 instance, security group, Route53 records**).
2. Generates an Ansible inventory file (`ansible/inventory.ini`) with the EC2 instance’s public IP.
3. Triggers the Ansible playbook to deploy the application.

#### **Ansible**
1. Waits for SSH to be available on the EC2 instance.
2. Installs dependencies (**Docker, Docker Compose, Git**) using the **dependencies** role.
3. Deploys the TODO application using the **deployment** role:
   - Clones the application repository: [https://github.com/onlydurodola/hng12-stage4-todo-app.git](https://github.com/onlydurodola/hng12-stage4-todo-app.git).
   - Builds and runs Docker containers using `docker-compose up -d --build`.
   - Waits for the application to be accessible at [https://oluwatobiloba.tech](https://oluwatobiloba.tech).

## Requirements

### **Software Prerequisites**

#### Terraform (>= 1.5.0)
```sh
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform
```

#### Ansible (>= 2.9.0)
```sh
sudo apt update
sudo apt install python3-pip
pip3 install --user ansible
```

#### AWS CLI (Optional)
```sh
sudo snap install aws-cli --classic
```

### **AWS Account Prerequisites**

- An **AWS account** with permissions to:
  - Create EC2 instances (**AmazonEC2FullAccess**).
  - Manage Route53 records (**AmazonRoute53FullAccess**).
- A **Route53 hosted zone** for `oluwatobiloba.tech`.
- An **EC2 key pair** (e.g., `numbers.pem`) for SSH access.

### **Hardware Prerequisites**

- An **EC2 instance** with:
  - **Ubuntu 22.04 LTS** (or compatible OS).
  - **t2.medium** instance (minimum 2 vCPUs, 4 GB RAM).
  - Internet access for downloading dependencies and interacting with AWS APIs.

## Setup Instructions

### **1. Clone the Infrastructure Repository**
```sh
git clone https://github.com/onlydurodola/hng12-stage4-todo-infra.git
cd hng12-stage4-todo-infra
```

### **2. Configure AWS Credentials**
#### **Option 1: Attach an IAM Role** (Recommended for EC2 Instances)
```sh
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

#### **Option 2: Configure Credentials Manually**
```sh
export AWS_ACCESS_KEY_ID="your-access-key-id"
export AWS_SECRET_ACCESS_KEY="your-secret-access-key"
export AWS_DEFAULT_REGION="us-east-1"
```
Or use AWS CLI:
```sh
aws configure
```

### **3. Configure Terraform Variables**
Navigate to the Terraform directory:
```sh
cd terraform
nano variables.tf
```
Modify the following values:
```hcl
variable "aws_region" {
  default = "us-east-1"
}

variable "ami_id" {
  default = "ami-0e86e20dae9224db8"  # Update for your region
}

variable "instance_type" {
  default = "t2.medium"
}

variable "key_name" {
  default = "numbers"  # Replace with your key pair name
}

variable "domain_name" {
  default = "oluwatobiloba.tech"
}
```
Save and exit (`Ctrl+O`, `Enter`, `Ctrl+X`).

Ensure `numbers.pem` is in `~/.ssh/` and has correct permissions:
```sh
chmod 400 ~/.ssh/numbers.pem
```

## Application Source Code
The TODO application source code is hosted at:  
[https://github.com/onlydurodola/hng12-stage4-todo-app.git](https://github.com/onlydurodola/hng12-stage4-todo-app.git)

## Directory Structure
```
hng12-stage4-todo-infra/
.
├── README.md
├── ansible
│   ├── playbook.yaml
│   └── roles
│       ├── dependencies
│       │   └── tasks
│       │       └── main.yaml
│       └── deployment
│           └── tasks
│               └── main.yaml
├── ansible.cfg
└── terraform
    ├── inventory.tpl
    ├── main.tf
    ├── output.tf
    ├── providers.tf
    └── variables.tf
```

## Troubleshooting

### **Terraform Authentication Issues**
- Ensure AWS credentials are configured correctly.
- Verify IAM role permissions (**AmazonEC2FullAccess**, **AmazonRoute53FullAccess**).

### **Ansible Playbook Fails**
- Check Ansible logs.
- Verify SSH access:
```sh
ssh -i ~/.ssh/numbers.pem ubuntu@<instance-public-ip>
```

### **Application Not Accessible**
- Check running Docker containers:
```sh
sudo docker ps
```
- Verify Route53 records:
```sh
dig oluwatobiloba.tech
```

## Cleanup
```sh
cd terraform
terraform destroy -auto-approve
# hng12-stage4-todo-infra
